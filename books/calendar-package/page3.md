---
title: "Flutter パッケージの開発の全体像"
---

実際に手を動かす前に、まずは Flutter パッケージ開発の流れを確認しましょう。

なお、このチャプターで説明する内容の大部分は公式ドキュメントの [Developing packages & plugins](https://docs.flutter.dev/development/packages-and-plugins/developing-packages) の内容に従っています。さらに詳しい内容が知りたい場合は公式ドキュメントを参照してください。

# パッケージの種類

ひとことに「パッケージ」と言っても 3 種類のタイプがあります。

1. Dart パッケージ
1. プラグインパッケージ
1. FFI プラグインパッケージ

このハンズオンで取り扱うのは __Dart パッケージ__ ではありますが、それ以外の種類についても用語として覚えておくことで、今後さまざまなドキュメントを読む上での助けになると思いますので、ひとつずつざっと説明します。

## Dart パッケージ

Dart で書かれた一般的なパッケージです。必ずしも Flutter に依存している必要はなく、たとえば [path] パッケージなどは Flutter に依存しない Dart コードによる処理のみが実装されているため、たとえばコマンドライン上で実行する Dart プログラムでも利用できます。

一方で、 Widget などの Flutter に依存したパッケージを開発したい場合は、`pubspec.yaml` の依存関係に Flutter を追加するだけで、他に特別なセットアップをする必要はありません。

基本的に Dart コードのみで記述されることになるため、インストール先のプラットフォームに関係なく幅広く利用できるメリットがあります。

## プラグインパッケージ

Dart パッケージの中でも、特にプラットフォーム固有の API を呼び出すパッケージは __プラグインパッケージ__ と呼ばれます。

例えば Android ネイティブの API を呼び出すための Kotlin コードと連携する実装を含むパッケージはこの種類に分類されます。

特定のプラットフォーム固有の API を呼び出すため、対応していないプラットフォーム向けのアプリケーションでは利用できません。

## FFI プラグインパッケージ

FFI を利用してC言語によるネイティブAPIを呼び出すパッケージは __FFI プラグインパッケージ__ と呼ばれます。

---

先述の通り、このハンズオンでは __Dart パッケージ__ を実装します。具体的には、以下の2つのパッケージと、それらを利用した Flutter アプリです。

1. calendar_logic
特定の日付を保持する `DateTime` オブジェクトを入力とし、その日付が含まれる月の1ヶ月分のカレンダーデータを生成するパッケージです。

Flutter には依存しない Dart パッケージで、ユニットテストによる動作確認が可能です。

2. calendar_widget
`calendar_logic` パッケージが生成したカレンダーデータを利用して、実際のカレンダーと同等の見た目を実現する `Calendar` Widget を提供する Dart パッケージです。

Widget を提供する必要があるため、依存関係に Flutter を含みます。UI を含むパッケージであるため、動作確認には Widget テストの手法を用いる必要があります。

つまり、このハンズオンで開発するパッケージとアプリの依存関係は以下の通りです。

![依存関係の図]()

# パッケージの大まかな開発手順

詳細な手順については後のチャプターで1手順ずつ確認していきますが、ここでは Dart パッケージの開発の大まかな流れを確認しましょう。

## プロジェクトの作成

まずはプロジェクトを作成します。

Dart パッケージのプロジェクトに必要な最低限のフォルダとファイルは以下の通りです。

- lib フォルダ
  - .dart ファイル
- pubspec.yaml ファイル

非常にシンプルですね。

`pubspec.yaml` ファイルに依存関係や設定を書くのは Flutter アプリと同様です。また、実装は `lib` フォルダ内の `.dart` ファイルに記述します。通常はパッケージ名と同じ名前の `.dart` ファイルを配置し、そこに実装を記述します。

ただし、パッケージを [pub.dev](https://pub.dev) に公開する際は他にもいくつかのファイルが必要になります。代表的なものは以下の通りです。

- `CHANGELOG.md`
  - バージョンごとの変更履歴を記述します。このファイルに書かれた内容を元に、pub.dev の "Changelog" タブが生成されます。
- `LICENSE` 
  - パッケージのライセンス情報を記述します。pub.dev では画面右下の "License" 部分にこのファイルへのリンクが表示されます。また一般的なライセンスの場合はそのライセンスの種類も自動で読み取って表示されます。
- `README.md`
  - パッケージの利用方法などの説明を記述します。pub.dev 上でのパッケージのトップページの生成に利用されるだけでなく、GitHub 上でもトップページにこのファイルの内容が表示されるため、必ず必要になります。

これらのファイルを手作業で生成するのは大変ですので、`flutter` および `dart` コマンドにはプロジェクトを生成するためのコマンドが以下のように用意されています。

```
$ flutter create -t package [パッケージ名]
```

見ての通り、 `-t package` オプションが追加されている以外は Flutter アプリプロジェクトを生成する際と同様です。基本的にはこのコマンドを利用してプロジェクトを生成すると良いでしょう。

## コーディング

プロジェクトを生成したら、次は `lib` フォルダに配置した `.dart` ファイルに Dart コードを記述します。

パッケージだからと特に難しく考える必要はなく、通常アプリ開発でコーディングするのと同じ感覚で共通利用できるクラスやメソッドを書けば良いでしょう。

たとえば、`flutter create` コマンドによって自動生成されたプロジェクトには、サンプルコードとして以下のインクリメントロジックが記述されています。

```dart
library calendar_logic;

/// A Calculator.
class Calculator {
  /// Returns [value] plus 1.
  int addOne(int value) => value + 1;
}
```

ファイルの頭に `library [パッケージ名]` の記述が必要な点だけは注意してください。

## 動作確認

パッケージには共通利用されるクラスやメソッドのみが記述するため、それらを「利用する」コードは含まれません。そのため、単純に実行ボタンを押して実行することはできません。

そのため、テストコードを書いて実行すると良いでしょう。

自動生成されたプロジェクトには `test` フォルダが含まれているため、そこに適切なテストコードを書いて実行することでパッケージのコードが正しく動作しているかが確認できます。

## パッケージの公開

開発したパッケージは `flutter pub publish` コマンドで公開でき、公開されたパッケージは `pub.dev` サイトで自動的に閲覧可能な状態になります。また世界中の開発者は `pubspeck.yaml` ファイルにパッケージ名を記述するだけでパッケージをインポートできるようになります。

一方で、パッケージをインポートする方法はそれだけではありません。GitHub リポジトリを指定したり、ローカルのファイルパスを指定する方法でもパッケージはインポート可能です。

実際にパッケージを公開してしまうと、pub.dev の規約により「取り下げる」ことはできないため、ハンズオンで開発したパッケージを公開するのは不適切です。

このハンズオンでは「ローカルのファイルパスを指定する」方法でパッケージを取り込み、アプリを開発することをゴールとしています。

---

これで前置きは終了です。それでは、次のチャプターからは実際に手を動かしながらパッケージを開発していきましょう。